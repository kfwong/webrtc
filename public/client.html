<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>webrtc</title>
</head>

<body style="background-color: black;">
    <div id="root"></div>
    <h1 style="color: white;">Click/Tap anywhere!</h1>
    <canvas class="fireworks"></canvas>
    <div id="status"
         style="font-size: 10; color: green;"></div>

</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.2.0/anime.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.1.2/simplepeer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.dev.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.min.js"></script>
<script type="text/javascript">

    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyCwsUgjOL08tNrAZ_Mq012YmrUWZ5Z1NAk",
        authDomain: "fomosumos.firebaseapp.com",
        databaseURL: "https://fomosumos.firebaseio.com",
        projectId: "fomosumos",
        storageBucket: "fomosumos.appspot.com",
        messagingSenderId: "903886436512"
    };

    firebase.initializeApp(config);

    // Initialize Cloud Firestore through Firebase
    var db = firebase.firestore();

    // Disable deprecated features
    db.settings({
        timestampsInSnapshots: true
    });

    var playerName = faker.name.lastName();

    // 2. Player join room.
    console.log("player join room")
    db.collection('rooms/randomKey/players').doc(playerName).set({});

    // 4. Listen to the even when display sends an offer, set offer and send back answer.
    var p = new SimplePeer({ initator: false, trickle: false });
    var detachListener = db.collection('rooms/randomKey/players').doc(playerName).onSnapshot(snapshot => {
        const offer = snapshot.data().offer;
        if (offer) {

            p.on('signal', data => {

                console.log("send answer")
                snapshot.ref.set({
                    answer: data
                }, { merge: true })

                // detach listener
                detachListener()
            })

            console.log("set offer");
            p.signal(offer);
        }
    })

    p.on('error', error => {
        console.log(error)
    });

    p.on('connect', () => {
        console.log('connect');
    })

    p.on('close', () => {
        console.log("close");
        p.destroy();
    });


    window.human = false;

    var canvasEl = document.querySelector('.fireworks');
    var ctx = canvasEl.getContext('2d');
    var numberOfParticules = 30;
    var pointerX = 0;
    var pointerY = 0;
    var tap = ('ontouchstart' in window || navigator.msMaxTouchPoints) ? 'touchstart' : 'mousedown';
    var colors = ['#FF1461', '#18FF92', '#5A87FF', '#FBF38C'];

    function setCanvasSize() {
        canvasEl.width = window.innerWidth * 2;
        canvasEl.height = window.innerHeight * 2;
        canvasEl.style.width = window.innerWidth + 'px';
        canvasEl.style.height = window.innerHeight + 'px';
        canvasEl.getContext('2d').scale(2, 2);
    }

    function updateCoords(e) {
        pointerX = e.clientX || e.touches[0].clientX;
        pointerY = e.clientY || e.touches[0].clientY;
    }

    function setParticuleDirection(p) {
        var angle = anime.random(0, 360) * Math.PI / 180;
        var value = anime.random(50, 180);
        var radius = [-1, 1][anime.random(0, 1)] * value;
        return {
            x: p.x + radius * Math.cos(angle),
            y: p.y + radius * Math.sin(angle)
        }
    }

    function createParticule(x, y) {
        var p = {};
        p.x = x;
        p.y = y;
        p.color = colors[anime.random(0, colors.length - 1)];
        p.radius = anime.random(16, 32);
        p.endPos = setParticuleDirection(p);
        p.draw = function () {
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius, 0, 2 * Math.PI, true);
            ctx.fillStyle = p.color;
            ctx.fill();
        }
        return p;
    }

    function createCircle(x, y) {
        var p = {};
        p.x = x;
        p.y = y;
        p.color = '#FFF';
        p.radius = 0.1;
        p.alpha = .5;
        p.lineWidth = 6;
        p.draw = function () {
            ctx.globalAlpha = p.alpha;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius, 0, 2 * Math.PI, true);
            ctx.lineWidth = p.lineWidth;
            ctx.strokeStyle = p.color;
            ctx.stroke();
            ctx.globalAlpha = 1;
        }
        return p;
    }

    function renderParticule(anim) {
        for (var i = 0; i < anim.animatables.length; i++) {
            anim.animatables[i].target.draw();
        }
    }

    function animateParticules(x, y) {
        var circle = createCircle(x, y);
        var particules = [];
        for (var i = 0; i < numberOfParticules; i++) {
            particules.push(createParticule(x, y));
        }
        anime.timeline().add({
            targets: particules,
            x: function (p) { return p.endPos.x; },
            y: function (p) { return p.endPos.y; },
            radius: 0.1,
            duration: anime.random(1200, 1800),
            easing: 'easeOutExpo',
            update: renderParticule
        })
            .add({
                targets: circle,
                radius: anime.random(80, 160),
                lineWidth: 0,
                alpha: {
                    value: 0,
                    easing: 'linear',
                    duration: anime.random(600, 800),
                },
                duration: anime.random(1200, 1800),
                easing: 'easeOutExpo',
                update: renderParticule,
                offset: 0
            });
    }

    var render = anime({
        duration: Infinity,
        update: function () {
            ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        }
    });

    document.addEventListener(tap, function (e) {
        window.human = true;
        render.play();
        updateCoords(e);
        animateParticules(pointerX, pointerY);

        // broadcast to all peers
        console.log("sending coordinates via webrtc");
        p.send(JSON.stringify({ type: "fireworks", x: pointerX, y: pointerY }));

    }, false);

    setCanvasSize();
    window.addEventListener('resize', setCanvasSize, false);

    function insertText(text) {
        var p = document.createElement("p");
        var t = document.createTextNode(text);
        p.appendChild(t);
        document.querySelector('#status').appendChild(p);
    }
</script>

</html>